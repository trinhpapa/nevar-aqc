var TestDepartment=function(){var n={getInvoiceAsync:function(n,t,i,r,u,f,e){e===!0&&$(TestDepartment.htmlTag.table_tag).LoadingTable();$.ajax({type:"POST",data:{pageIndex:n,pageSize:t,createdTime:i,resultDay:r,status:u,searchFilter:f},url:"/TestDepartment/GetInvoiceForManagerAsync",success:function(t){e===!0&&$(TestDepartment.htmlTag.table_tag).LoadedTable();$(TestDepartment.htmlTag.table_tag).html(t);window.sessionStorage.setItem("tablePageIndex",n);$(TestDepartment.htmlTag.pagination_tag).paginationBinding(n,10)},error:function(n){console.log("Get requirement type error: "+n)}})},updateStatusInvoideAsync:function(n,t){$.ajax({type:"PUT",data:{Id:n,ProcessStatusId:t},url:"/TestDepartment/ChangeStatusAsync",success:function(){toastr.success("Tiếp nhận thành công","Thông báo")},error:function(n){console.log("Update requirement type error: "+n)}})},getTestMethodList:function(){$.ajax({type:"GET",url:"/TestMethod/GetTestMethodAsync",success:function(n){let t=[];$.each(n,function(n,i){let r=i.symbolAttached===null?i.name:i.name+" "+i.symbolAttached;t.push({id:i.id,value:r,text:r,propertyId:i.testPropertyId})});window.sessionStorage.setItem("test-method-list",JSON.stringify(t))},error:function(n){console.log("Get test object error: "+n)}})},getUserList:function(){$.ajax({type:"GET",url:"/User/GetAllAsync",success:function(n){let t=[];$.each(n,function(n,i){t.push({id:i.id,value:i.displayName})});window.sessionStorage.setItem("user-list",JSON.stringify(t))},error:function(n){console.log("Get user error: "+n)}})},getDetailTestRequirementByIdAsync:function(n){$(TestDepartment.htmlTag.plan_loading).show();$(TestDepartment.htmlTag.modal_plan_body).find(".table").remove();$.ajax({type:"POST",data:{id:n},url:"/TestDepartment/GetDetailTestRequirementByIdAsync",success:function(n){$(TestDepartment.htmlTag.modal_plan_body).append(n);$(TestDepartment.htmlTag.plan_loading).hide();TestDepartment.bindingData.bindingSelectTestMethod();TestDepartment.bindingData.bindingImplementer();$(".from-date-picker,.to-date-picker").each(function(){$(this).datepicker({minDate:todayFull,uiLibrary:"bootstrap4",format:"dd/mm/yyyy"})})},error:function(n){console.log("Get details error: "+n)}})},updatePlanAsync:function(n){$(n).attr("data-plan-mode")==="update"&&($(n).buttonLoading(),$.confirm({message:"Xác nhận lưu kế hoạch thử nghiệm?",onOk:function(){let t=TestDepartment.handleEvent.claimPlanData(n);$.ajax({type:"POST",data:{model:t},url:"/TestDepartment/UpdatePlanAsync",success:function(){$(n).hide();toastr.success("Cập nhật kế hoạch thử nghiệm thành công","Thông báo:")},error:function(){$(n).buttonLoaded(!1);toastr.error("Cập nhật kế hoạch thử nghiệm thất bại","Thông báo:")}})},onCancel:function(){$(n).buttonLoaded(!1)}}))},getSummaryOfResult:function(n){$.ajax({type:"POST",url:"/TestDepartment/GetRequirementInvoiceForSummary",data:{invoiceId:n},success:function(n){$(TestDepartment.htmlTag.modal_summary_of_result_body).html(n)},error:function(n){toastr.error(n.responseText,"Thông báo:")}})},submitSummaryOfResult:function(n){$(n).buttonLoading();$.confirm({message:'Xác nhận kết quả phiếu này?<br><i class="text-danger font-weight-bold">*Lưu ý: Thao tác không thể thu hồi<\/i>',onOk:function(){let t=$(n).attr("data-id");$.ajax({type:"POST",data:{Id:t,ProcessStatusId:5},url:"/TestDepartment/SubmitSummaryOfResults",success:function(){$(n).buttonLoaded(!0);toastr.success("Xác nhận kết quả thành công!","Thông báo")},error:function(t){$(n).buttonLoaded(!1);toastr.error(t.responseText,"Thông báo")}})},onCancel:function(){$(n).buttonLoaded(!1)}})},deleteSummaryOfResultItem:function(n){$.confirm({message:'Xác nhận hủy kết quả này?<br><i class="text-danger font-weight-bold">*Lưu ý: Thao tác không thể thu hồi<\/i>',onOk:function(){let t=$(n).attr("data-id");$.ajax({type:"POST",data:{Id:t},url:"/TestDepartment/DeleteSummaryOfResultItemAsync",success:function(){toastr.success("Hủy kết quả thành công!","Thông báo")},error:function(n){toastr.error(n.responseText,"Thông báo")}})}})}},t={claimPlanData:function(n){let i=$(TestDepartment.htmlTag.modal_plan_body).find("table tr[data-property]"),t=[];return $.each(i,function(i,r){let f=parseInt($(this).attr("data-property")),e=$(r).find(".from-date-picker").val();if(e.length<1){$(n).buttonLoaded(!1);toastr.error("Thời gian không được để trống!","Cảnh báo:");throw"From time has required";}let o=$(r).find(".to-date-picker").val();if(o.length<1){$(n).buttonLoaded(!1);toastr.error("Thời gian không được để trống!","Cảnh báo:");throw"To time has required";}let h=$(r).find("select.test-method").val(),s=[],u=$(r).find("input.implementer").val();if(u.length<1){$(n).buttonLoaded(!1);toastr.error("Người thực hiện không được để trống!","Cảnh báo:");throw"Implementer has required";}u=JSON.parse(u);$.each(u,function(n,t){s.push({SpecimenPropertyId:f,UserId:t.id,IsAccept:!1})});t.push({Id:f,PlanFromTime:e,PlanToTime:o,TestMethodId:h,IDTRImplementerEntities:s})}),t}},i={bindingSelectTestMethod:function(){$("select.test-method").select2({theme:"bootstrap-sm",width:"100%"})},bindingImplementer:function(){let n=JSON.parse(window.sessionStorage.getItem("user-list"));$("input.implementer").tagify({maxTags:2,enforceWhitelist:!0,whitelist:n})}};return{htmlTag:{table_tag:"#table-content",pagination_tag:"#pagination-tag",invoice_status_update_tag:".invoice-status-update",invoice_no_tag:"#invoice-no",modal_plan_tag:"#modalPlanManager",modal_plan_body:"#modalPlanManager .modal-body",modal_summary_of_result:"#modal-summary-of-results",modal_summary_of_result_body:"#modal-summary-of-results .modal-body",plan_manager:".plan-manager",plan_loading:"#plan-loading"},bindingData:i,ajaxRequest:n,handleEvent:t}}();systemHub.on("InvoiceUpdate",()=>{let n=window.sessionStorage.getItem("tablePageIndex");TestDepartment.ajaxRequest.getInvoiceAsync(n,15,null,null,null,null,!1)});