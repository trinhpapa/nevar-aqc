var receptionDepartment=function(){var n={summaryOfInvoice:"#summary-of-invoice",testRequirementForm:"#test-requirement-form",calibrationRequirementForm:"#calibration-requirement-form",contentData:$("#content-data"),filterTable:$("#filter-table"),filterTableCancel:"#filter-table-cancel",filterTableAction:"#filter-table-action",editRow:".edit-row",deleteRow:".delete-row",modalRequirementForm:$("#modal-requirement-form"),modalPrintInvoice:$("#modal-print-invoice"),liAutoComplete:".ui-menu-item",selectRequirementType:"#requirement-type",resetFormTag:"#reset-form",hideFormTag:"#hide-form",submitFormTag:"#submit-form",printFormTag:"#print-form",invoiceNo:"#invoice-no",paginationTag:"#pagination-tag",requirementFilter:"#requirement-filter",searchFilterForm:"#search-filter-form",searchContent:"#search-content",testField:"#test-field",testCustomerName:"#test-customer-name",customerNameClass:".customer-name",testCustomerAddress:"#test-customer-address",customerAddressClass:".customer-address",customer_phone_tag:"#customer_phone",customer_phone_class:".customer_phone",customer_fax_tag:"#customer_fax",customer_fax_class:".customer_fax",customer_note_tag:"#customer_note",customer_note_class:".customer_note",testRepresentative:"#test-representative",testSymbolSpecimenStatus:"#test-symbol-specimen-status",testSymbolSpecimenAmount:"#test-symbol-specimen-amount",testSymbolSpecimenNote:"#test-symbol-specimen-note",testIsUseSubcontractors:"input[name=TestIsUseSubcontractors]:checked",testResultDay:"#datePickerTest",testSaveSpecimenTime:"input[name=TestSaveSpecimenTime]",testIsSaveSpecimen:"input[name=TestIsSaveSpecimen]:checked",testResultType:"input[name=TestResultType]:checked",testResultInvoiceAmount:"input[name=TestResultInvoiceAmount]",testItemAdd:".test-item-add",testItemRemove:".test-item-remove",copyProperty:".copy-property",pasteProperty:".paste-property",testItemHtml:'<tr>  <td><select style="max-width: 200px" class="test-object form-control form-control-sm form-required"><\/select><\/td>  <td><input type="text" class="specimen-name form-control form-control-sm form-required" /><\/td>  <td><input type="text" class="specimen-symbol form-control form-control-sm" /><\/td>  <td><input style="width= 50px" type="number" value="1" min="1" max="100" maxlength="3" class="specimen-amount form-control form-control-sm form-required" /><\/td>  <td><input type="text" class="specimen-quantum form-control form-control-sm" /><\/td>  <td><input type="text" class="specimen-status form-control form-control-sm" /><\/td>  <td><a class="btn btn-sm btn-primary text-white data-property" tl-tooltip="Thêm chỉ tiêu" data-toggle="modal" data-target="#modal-test-property"><i class="fa fa-plus"><\/i> <span class="count-property">0<\/span> chỉ tiêu<\/a><\/td>  <td class="table-control control-right">      <a tl-tooltip="Copy chỉ tiêu"><i class="fas fa-copy text-primary mouse-pointer copy-property"><\/i><\/a>      <a tl-tooltip="Paste chỉ tiêu"><i class="fas fa-paste text-warning mouse-pointer paste-property"><\/i><\/a>      <a tl-tooltip="Thêm mẫu này"><i class="fas fa-check text-success mouse-pointer test-item-add"><\/i><\/a>      <a tl-tooltip="Xóa"><i class="fas fa-times text-danger mouse-pointer test-item-remove"><\/i><a>  <\/td><\/tr >',modalTestProperty:$("#modal-test-property"),tableTestProperty:"#table-test-property > tbody",contentTableTestProperty:'<tr><td><select name="test-property" class="form-control form-control-sm"><option value="0">Chọn một chỉ tiêu<\/option><\/select><\/td><td><select name="test-method" class="form-control form-control-sm"><option value="0">Chọn một phương pháp hoặc không<\/option><\/select><\/td><td class="text-center" style="width: 39px;">    <i class="fas fa-times text-danger mouse-pointer test-property-item-remove" title="Xóa"><\/i><\/td><\/tr>',addTestProperty:"#add-test-property",updateTestProperty:"#update-test-property",TestPropertyItemRemove:".test-property-item-remove",submitTestUpdate:"#submit-test-update",cancelTestUpdate:"#cancel-test-update"},t={getCustomerList:function(){$.ajax({type:"GET",url:"/Customer/CustomerList",success:function(n){window.sessionStorage.setItem("customer-list",JSON.stringify(n))},error:function(n){console.log("Get customer error: "+n)}})},getRequirementTypeList:function(){$.ajax({type:"GET",url:"/ReceptionDepartment/GetRequirementTypeAsync",success:function(n){window.sessionStorage.setItem("requirement-type-list",JSON.stringify(n))},error:function(n){console.log("Get requirement type error: "+n)}})},getTestObjectList:function(){$.ajax({type:"GET",url:"/TestObject/GetTestObjectAsync",success:function(n){let t=[];$.each(n,function(n,i){t.push({id:i.id,text:i.name,value:i.name,field:i.fieldId})});window.sessionStorage.setItem("test-object-list",JSON.stringify(t))},error:function(n){console.log("Get test object error: "+n)}})},getTestPropertyList:function(){$.ajax({type:"GET",url:"/TestProperty/GetTestPropertyAsync",success:function(n){let t=[];$.each(n,function(n,i){t.push({id:i.id,text:i.name.replace(/(<.?su[bp]>)/g,""),value:i.name.replace(/(<.?su[bp]>)/g,""),object:i.objectId})});window.sessionStorage.setItem("test-property-list",JSON.stringify(t))},error:function(n){console.log("Get test object error: "+n)}})},getTestMethodList:function(){$.ajax({type:"GET",url:"/TestMethod/GetTestMethodAsync",success:function(n){console.log(n);let t=[];$.each(n,function(n,i){let r=i.symbolAttached&&i.name+" "+i.symbolAttached||i.name;t.push({id:i.id,value:r,text:r,propertyId:i.testPropertyId})});window.sessionStorage.setItem("test-method-list",JSON.stringify(t))},error:function(n){console.log("Get test object error: "+n)}})},getInvoiceAsync:function(n,t,i,r,u,f,e,o){o===!0&&$(receptionDepartment.htmlTag.contentData).LoadingTable();$.ajax({type:"POST",data:{pageIndex:n,pageSize:t,requirementType:i,createdTime:r,resultDay:u,status:f,searchFilter:e},url:"/ReceptionDepartment/GetInvoiceAsync",success:function(t){o===!0&&$(receptionDepartment.htmlTag.contentData).LoadedTable();$(receptionDepartment.htmlTag.contentData).html(t);window.sessionStorage.setItem("tablePageIndex",n);$(receptionDepartment.htmlTag.paginationTag).paginationBinding(n,15)},error:function(n){console.log("get invoice error: "+n)}})},getSummaryAsync:function(n,t,i,r,u,f,e,o){o===!0&&$(receptionDepartment.htmlTag.contentData).LoadingTable();$.ajax({type:"POST",data:{pageIndex:n,pageSize:t,requirementType:i,createdTime:r,resultDay:u,status:f,searchFilter:e},url:"/ReceptionDepartment/GetSummaryAsync",success:function(t){o===!0&&$(receptionDepartment.htmlTag.contentData).LoadedTable();$(receptionDepartment.htmlTag.contentData).html(t);window.sessionStorage.setItem("tablePageIndex",n);$(receptionDepartment.htmlTag.paginationTag).paginationBinding(n,15)},error:function(n){console.log("get invoice error: "+n)}})},getInvoiceByIdAsync:function(){$.ajax({type:"POST",data:{invoiceId:0},url:"/ReceptionDepartment/GetByIdAsync",success:function(n){let t=JSON.parse(n)},error:function(){console.log("getInvoiceByIdAsync error!!!")}})},getInvoiceByIdForUpdateAsync:function(n){return $.ajax({type:"POST",data:{invoiceId:n},url:"/receptiondepartment/getbyidforupdateasync"})},submitFormTRequirement:function(){receptionDepartment.handleEvent.disabledButtonFunction();$(receptionDepartment.htmlTag.submitFormTag).buttonLoading();let t=$(receptionDepartment.htmlTag.selectRequirementType).find("option:selected").data("alias"),n;t==="YCTN"&&(n=receptionDepartment.handleEvent.claimTestRequirementFormData());t==="YCHC"&&(n=receptionDepartment.handleEvent.claimTestRequirementFormData());n===!1&&($(receptionDepartment.htmlTag.submitFormTag).buttonLoaded(!1),$(receptionDepartment.htmlTag.submitFormTag).toggleDisabled());n!==!1?$.ajax({type:"POST",data:n,url:"/receptiondepartment/createasync",success:function(n){toastr.success("Câp nhật thành công","Thông báo");$(receptionDepartment.htmlTag.submitFormTag).buttonLoaded();receptionDepartment.handleEvent.enabledButtonFunction();receptionDepartment.handleEvent.disableForm();receptionDepartment.handleEvent.enablePrintMode();let t=JSON.parse(n);$(receptionDepartment.htmlTag.invoiceNo).val(t.InvoiceNo);$(receptionDepartment.htmlTag.printFormTag).attr("data-invoice",t.InvoiceNo);$(receptionDepartment.htmlTag.printFormTag).attr("data-edition",t.Edition);$(receptionDepartment.htmlTag.printFormTag).attr("data-target","#modal-print-invoice");$(receptionDepartment.htmlTag.printFormTag).attr("data-toggle","modal")},error:function(n){toastr.error("Xảy ra lỗi, thử lại sau","Thông báo");console.error(n.responseText);$(receptionDepartment.htmlTag.submitFormTag).buttonLoaded(!1);receptionDepartment.handleEvent.enabledButtonFunction();$("#loading-form").hide()}}):($(receptionDepartment.htmlTag.submitFormTag).buttonLoaded(!1),receptionDepartment.handleEvent.enabledButtonFunction(),$("#loading-form").hide())},removeInvoiceAsync:function(n){$.ajax({type:"POST",data:{invoiceId:n},url:"/receptiondepartment/removeasync",success:function(){toastr.success("Hủy phiếu thành công!","Thông báo")},error:function(){toastr.error("Thất bại, thử lại sau!","Thông báo")}})},getListEditionByInvoiceNo:function(n){return $.ajax({type:"POST",data:{invoiceNo:n},url:"receptiondepartment/GetListEditionByInvoiceNo"})},updateInvoiceAsync:function(n){return $.ajax({type:"POST",data:n,url:"/receptiondepartment/updateinvoiceasync"})}},i={requirementTypeSelect:function(){let n=JSON.parse(window.sessionStorage.getItem("requirement-type-list"));$(receptionDepartment.htmlTag.selectRequirementType).empty();$.each(n,function(n,t){$(receptionDepartment.htmlTag.selectRequirementType).append('<option data-alias="'+t.alias+'" value="'+t.id+'">'+t.vietnamese+" ("+t.english+")<\/option>")});$(receptionDepartment.htmlTag.selectRequirementType).select2({theme:"bootstrap-sm",width:"100%",dropdownAutoWidth:!0})},requirementTypeFilterSelect:function(){let n=JSON.parse(window.sessionStorage.getItem("requirement-type-list"));$(receptionDepartment.htmlTag.requirementFilter).empty();$(receptionDepartment.htmlTag.requirementFilter).append('<option value="0">Tất cả<\/option>');$.each(n,function(n,t){$(receptionDepartment.htmlTag.requirementFilter).append('<option data-alias="'+t.alias+'" value="'+t.id+'">'+t.vietnamese+" ("+t.english+")<\/option>")});$(receptionDepartment.htmlTag.requirementFilter).select2({theme:"bootstrap-sm",width:"360px",dropdownAutoWidth:!0})},formInputFromRequirementType:function(n){let t=$("option:selected",n).data("alias");receptionDepartment.handleEvent.resetForm();t==="YCTN"&&($(receptionDepartment.htmlTag.calibrationRequirementForm).hide(),$(receptionDepartment.htmlTag.testRequirementForm).show());t==="YCHC"&&($(receptionDepartment.htmlTag.testRequirementForm).hide(),$(receptionDepartment.htmlTag.calibrationRequirementForm).show())}},r={addTestPropertyItem:function(n,t,i){$(receptionDepartment.htmlTag.tableTestProperty).append(receptionDepartment.htmlTag.contentTableTestProperty).find("select[name=test-property]:last").select2({data:JSON.parse(window.sessionStorage.getItem("test-property-list")).where(function(t){return t.object===parseInt(n)}),theme:"bootstrap-sm",width:"100%",dropdownAutoWidth:!0}).change(function(n){n.preventDefault();let t=$(this).val();$(this).closest("tr").find("select[name=test-method]").html('<option value="0">Chọn một phương pháp hoặc không<\/option>');$(this).closest("tr").find("select[name=test-method]").select2({data:JSON.parse(window.sessionStorage.getItem("test-method-list")).where(function(n){return n.propertyId===parseInt(t)}),theme:"bootstrap-sm",width:"100%",dropdownAutoWidth:!0}).val(i===undefined?"0":i===null?"0":i).trigger("change")}).val(t===undefined?"0":t).trigger("change")},resetForm:function(){let n=parseInt($(receptionDepartment.htmlTag.testField).val());$(receptionDepartment.htmlTag.testRequirementForm+" .table tbody").html(receptionDepartment.htmlTag.testItemHtml).find(".test-object").select2({data:JSON.parse(window.sessionStorage.getItem("test-object-list")).where(function(t){return t.field===n}),theme:"bootstrap-sm",width:"200px",dropdownAutoWidth:!0});$(receptionDepartment.htmlTag.invoiceNo).val("");$(receptionDepartment.htmlTag.testRequirementForm)[0].reset();$(receptionDepartment.htmlTag.calibrationRequirementForm)[0].reset()},disabledButtonFunction:function(){$(receptionDepartment.htmlTag.resetFormTag).prop("disabled",!0);$(receptionDepartment.htmlTag.hideFormTag).prop("disabled",!0);$(receptionDepartment.htmlTag.submitFormTag).prop("disabled",!0)},enabledButtonFunction:function(){$(receptionDepartment.htmlTag.resetFormTag).prop("disabled",!1);$(receptionDepartment.htmlTag.hideFormTag).prop("disabled",!1);$(receptionDepartment.htmlTag.submitFormTag).prop("disabled",!1)},enablePrintMode:function(){$(receptionDepartment.htmlTag.resetFormTag).hide();$(receptionDepartment.htmlTag.submitFormTag).hide();$(receptionDepartment.htmlTag.printFormTag).show()},disablePrintMode:function(){$(receptionDepartment.htmlTag.resetFormTag).show();$(receptionDepartment.htmlTag.submitFormTag).show();$(receptionDepartment.htmlTag.printFormTag).hide()},disableForm:function(){$(receptionDepartment.htmlTag.selectRequirementType).prop("disabled",!0);$(receptionDepartment.htmlTag.testRequirementForm+" input").prop("disabled",!0);$(receptionDepartment.htmlTag.testRequirementForm+" select").prop("disabled",!0);$(receptionDepartment.htmlTag.testRequirementForm).prop("disabled",!0);$(receptionDepartment.htmlTag.testRequirementForm+" textarea").prop("disabled",!0)},enableForm:function(){$(receptionDepartment.htmlTag.selectRequirementType).prop("disabled",!1);$(receptionDepartment.htmlTag.testRequirementForm+" input").prop("disabled",!1);$(receptionDepartment.htmlTag.testRequirementForm+" select").prop("disabled",!1);$(receptionDepartment.htmlTag.testRequirementForm).prop("disabled",!1);$(receptionDepartment.htmlTag.testRequirementForm+" textarea").prop("disabled",!1)},setCustomerAutoComplete:function(){let n=[];$.each(JSON.parse(window.sessionStorage.getItem("customer-list")),function(t,i){n.push("ID:"+i.id+" - "+i.name)});$(receptionDepartment.htmlTag.customerNameClass).autocomplete({source:n,select:function(n,t){t.item.value=t.item.value.replace(/(ID:\d+ - )/,"");let r=t.item.value,u=JSON.parse(window.sessionStorage.getItem("customer-list")),i=u.filter(function(n){return n.name===r});$(receptionDepartment.htmlTag.customerAddressClass).val(i[0].address);$(receptionDepartment.htmlTag.customer_phone_class).val(i[0].phoneNumber);$(receptionDepartment.htmlTag.customer_fax_class).val(i[0].fax);$(receptionDepartment.htmlTag.customer_note_class).val(i[0].note)}})},claimTestPropertyData:function(){let n=[];return $.each($(receptionDepartment.htmlTag.tableTestProperty).find("tr"),function(t,i){let r=$(i).find("select[name=test-property]").val(),u=$(i).find("select[name=test-method]").val();parseInt(r)!==0&&n.push({TestPropertyId:parseInt(r),TestMethodId:parseInt(u)===0?null:parseInt(u),OrderNumber:++t})}),n},claimTestRequirementFormData:function(){let n={},i={},t={},r=[];if($(receptionDepartment.htmlTag.testCustomerName).val()==="")return toastr.error("Khách hàng không được để trống","Thông báo"),!1;if($(receptionDepartment.htmlTag.testCustomerAddress).val()==="")return toastr.error("Địa chỉ không được để trống","Thông báo"),!1;if($(receptionDepartment.htmlTag.resultDay).val()==="")return toastr.error("Chưa chọn ngày dự kiến có kết quả","Thông báo"),!1;i.Name=$(receptionDepartment.htmlTag.testCustomerName).val();i.Address=$(receptionDepartment.htmlTag.testCustomerAddress).val();n.Representative=$(receptionDepartment.htmlTag.testRepresentative).val();n.SYSCustomerEntity=i;n.RequirementTypeId=$(receptionDepartment.htmlTag.selectRequirementType).val();n.SpecimenStatus=$(receptionDepartment.htmlTag.testSymbolSpecimenStatus).val();n.SpecimenAmount=$(receptionDepartment.htmlTag.testSymbolSpecimenAmount).val();n.OtherInformation=$(receptionDepartment.htmlTag.testSymbolSpecimenNote).val();n.IsUseSubcontractors=$(receptionDepartment.htmlTag.testIsUseSubcontractors).val();n.IsSaveSpecimen=$(receptionDepartment.htmlTag.testIsSaveSpecimen).val();n.SaveSpecimenTime=$(receptionDepartment.htmlTag.testSaveSpecimenTime).val();n.ResultDay=$(receptionDepartment.htmlTag.testResultDay).datepicker().val();n.ReturnInvoiceResultTypeId=$(receptionDepartment.htmlTag.testResultType).val();n.ResultInvoiceAmount=$(receptionDepartment.htmlTag.testResultInvoiceAmount).val();n.FieldId=$(receptionDepartment.htmlTag.testField).val();let u=$(receptionDepartment.htmlTag.testRequirementForm+" .table tbody").find("tr[data-confirm='true']");return u.length<1?(toastr.error("Chưa nhập mẫu nào","Thông báo"),!1):($.each(u,function(n,i){if(t={},$(i).data("confirm")===!0){if(t.ObjectId=$(i).find("select.test-object").val(),t.SpecimenName=$(i).find("input.specimen-name").val(),t.SpecimenSymbol=$(i).find("input.specimen-symbol").val(),t.SpecimenOrder=++n,t.SpecimenAmount=$(i).find("input.specimen-amount").val(),t.SpecimenStatus=$(i).find("input.specimen-status").val(),t.SpecimenQuantum=$(i).find("input.specimen-quantum").val(),t.IDTRTestPropertyEntities=JSON.parse(decodeURIComponent($(i).find("a[data-property]").data("property"))),t.IDTRTestPropertyEntities.length<1)return toastr.error("Chưa nhập chỉ tiêu nào","Thông báo"),!1;r.push(r.IDTestRequirementEntity=t)}}),n.IDTestRequirementEntities=r,n)},claimTestRequirementUpdateData:function(){let t={Name:$("#update-test-customer-name").val(),Address:$("#update-customer-address").val()},i=$("#update-representative").val(),n=[],r=$(".update-specimen-item");return $.each(r,function(t,i){let r={SpecimenCode:$(i).attr("data-code"),SpecimenName:$(i).find(".update-specimen-name").val(),SpecimenSymbol:$(i).find(".update-specimen-symbol").val()};n.push(r)}),{Representative:i,SYSCustomerEntity:t,IDTestRequirementEntities:n}}};return{htmlTag:n,bindingData:i,ajaxRequest:t,handleEvent:r}}();systemHub.on("CustomerListUpdate",()=>{receptionDepartment.ajaxRequest.getCustomerList()});systemHub.on("InvoiceUpdate",()=>{let n=window.sessionStorage.getItem("tablePageIndex"),t=window.sessionStorage.getItem("reception-table-mode");if(window.sessionStorage.getItem("summary-mode")==="false"){if(t==="normal"&&receptionDepartment.ajaxRequest.getInvoiceAsync(n,null,null,null,null,null,null,!1),t==="search"){let t=$("#searchFilter").val();receptionDepartment.ajaxRequest.getInvoiceAsync(n,null,null,null,null,null,t,!1)}if(t==="fill"){let t=$("#requirement-filter").val(),i=$("#created-time-filter").val(),r=$("#result-day-filter").val(),u=$("#status-filter").val();receptionDepartment.ajaxRequest.getInvoiceAsync(n,null,t,i,r,u,null,!1)}}if(window.sessionStorage.getItem("summary-mode")==="true"){if(t==="normal"&&receptionDepartment.ajaxRequest.getSummaryAsync(n,null,null,null,null,null,null,!1),t==="search"){let t=$("#searchFilter").val();receptionDepartment.ajaxRequest.getSummaryAsync(n,null,null,null,null,null,t,!1)}if(t==="fill"){let t=$("#requirement-filter").val(),i=$("#created-time-filter").val(),r=$("#result-day-filter").val(),u=$("#status-filter").val();receptionDepartment.ajaxRequest.getSummaryAsync(n,null,t,i,r,u,null,!1)}}});